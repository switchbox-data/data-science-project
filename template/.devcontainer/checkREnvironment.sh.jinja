#!/usr/bin/env bash
set -euo pipefail

# R Environment Check Script
# This script validates that R, renv, and pak are installed
# and restores the renv environment from lockfile if present

echo "ğŸ” Checking R environment..."

# Check if R is installed
if ! command -v R >/dev/null 2>&1; then
    echo "âŒ Error: R is not installed"
    echo "Please install R before continuing."
    exit 1
fi

echo "âœ… R is installed"

# Check if renv is installed
if ! R --slave -e "library(renv)" >/dev/null 2>&1; then
    echo "âŒ Error: renv package is not installed"
    echo "Please install renv: R -e \"install.packages('renv')\""
    exit 1
fi

echo "âœ… renv is installed"

# Check if pak is installed
if ! R --slave -e "library(pak)" >/dev/null 2>&1; then
    echo "âŒ Error: pak package is not installed"
    echo "Please install pak: R -e \"install.packages('pak')\""
    exit 1
fi

echo "âœ… pak is installed"

# Check if renv.lock exists and restore if needed
PROJECT_ROOT="$(dirname "$(dirname "$(realpath "$0")")")"
if [[ -f "$PROJECT_ROOT/renv.lock" ]]; then
    echo "ğŸ“¦ Found renv.lock file, restoring environment..."
    
    if Rscript -e "setwd('$PROJECT_ROOT'); renv::restore()"; then
        echo "âœ… R environment restored successfully"
    else
        echo "âŒ Error: Failed to restore R environment from renv.lock"
        echo "Please check the renv.lock file and try again"
        exit 2
    fi
else
    echo "â„¹ï¸  No renv.lock file found, skipping environment restoration"
fi

echo "ğŸ‰ R environment check completed successfully"
